显而易见的，本篇用来翻译学习[Unified Particle Physics for Real-Time Applications](https://dl.acm.org/doi/10.1145/2601097.2601152)这篇文章。不会都翻译。同时我发现谷歌翻译比我懂中文，所以很多都是谷歌翻译。  
## 遇到的词汇
stiff 刚性  
penalty force model 惩罚力模型  
configurations 构造  
least squares best transform 最小二乘变换  
sequential quadratic programming  SQP序列二次规划  
拉格朗日乘子  
Gauss's principle of least constraint  高斯最小约束
## 摘要
我们提出了用于实时视觉效果的统一动力学框架。 使用通过约束连接的粒子作为我们的基本构建块，可以使我们以统一的方式处理接触和碰撞，并且我们展示了这种表示如何足够灵活地建模具有双向相互作用的气体，液体，可变形固体，刚体和布料。 我们用传统的基于粒子的方法解决了一些常见的问题，并描述了一种基于位置动态的并行约束求解器，它对于实时应用足够有效。
## 相关工作
Gascuel和Gascuel [1994]使用位移约束为刚体和关节图形设置动画。 他们的工作被Faure [1999]和基于位置的动力学[Muller et al。 2007¨可以看作是他们方法的概括。 为了模拟刚体，Gascuel和Gascuel [1994]通过首先找到合适的旋转然后应用匹配的平移将位置位移转换为刚性变换。 他们的方法偏向于旋转而不是平移，因此我们改为使用刚性形状匹配[Muller等。 2005¨，找到最小二乘最佳变换。 Stam [2009]使用受约束的单纯形建立了一个统一的求解器，而在实时仿真的背景下，Jakobsen [2001]使用了通过约束连接的粒子对关节的角色进行建模。 Muller和Chentanez [¨2011b]使用通过形状匹配和距离约束连接的定向粒子表示法对弹性和塑性固体进行建模。  
尤为重要的统一模拟的一个方面是流体和固体的双向相互作用。卡尔森等。 [2004]提出了一种将刚体与基于网格的流体模拟耦合的方法。 Carlson [2004]还以统一的方式模拟刚性，熔融和流动的材料。 Guendelman等。 [2005]展示了如何将欧拉流体模拟与固体和薄壳变形体耦合。但是，基于网格的方法的完整讨论超出了本文的范围。 Muller等人探索了将颗粒流体与刚体耦合。 [¨2004b]，他们将SPH流体模拟耦合到基于网格的可变形对象。 Clavet等。 [2005]通过将粒子视为硬球并将脉冲施加到传统的刚体模拟器，将流体与刚体耦合。 Akinci等。 [Akinci et al。[2012]使用更精确的边界力计算将SPH流体与刚体耦合，并将其方法扩展为处理可变形固体。 2013b]。与这些作品相反，我们在同一框架内模拟流体和刚体。  
除了此处讨论的工作之外，我们还将在各节中引用更具体的相关工作。
## 3 Particle Representation
我们选择粒子作为所有物体类型的基本构建单位。粒子简单且容易实现，同时足够灵活来表示我们想要模拟的物体。通过使用粒子构建所有的物体，我们减少了需要处理的碰撞类型的数量，不需要复杂的算法来产生基于网格表示的物体间的联系(contact)。粒子的粒度适合平行化。为了发挥GPU的优势，我们选择那些考虑平行处理大量简单粒子交互的算法，而非顺序运行的先进算法。  
我们的核心粒子状态包含如下的属性：  
```cpp
struct Particle{
    float x[3];
    float v[3];
    float invmass;
    int phase;
}
```
我们用一个粒子phase标识符拓展了一般的动力学量。这个整数值用来将粒子组织成组，提供一个简单的方式来调整他们的属性，控制他们的交互，比如，禁用同组内粒子之间的碰撞。我们做了一个限制，将每个场景的粒子半径设为固定，以便利用基于均匀网格的有效碰撞检测。
## 4 平行SOR解算器
## 4.1 背景
我们构建了一个使用派生于PBD的通用约束解算器的系统。PBD系统包括非线性等式和不等式约束，  
$$
C_i(\vec x + \Delta \vec x) = 0,\ i = 1,...,n\ (1)
$$
$$
C_j(\vec x + \Delta \vec x) \ge 0,\ j = 1,...,n\ (2)
$$
公式中有 \\(\vec x = [\vec {x_1},\vec {x_2},...,\vec {x_n}]^T\\) ,x代表粒子的位置向量。约束的经典解算方式是使用GS迭代法，并且将\\(C\\)在\\(x\\)处展开，
$$
C_i(\vec x + \Delta \vec x) \approx C_i(\vec x) + \nabla C_i(\vec x)\Delta \vec x = 0.\ \ (3)
$$
位置变化量\\(\Delta \vec x\\)，被限制在沿着约束梯度的方向，使用质量导数矩阵 \\(M = diag(m_1,..,m_n)\\)加权，
$$
\Delta x = M^{-1}\nabla C_i(\vec x)^T\lambda _i\ \ (4)
$$
结合公式(3)和(4)，\\(\lambda _i\\)的公式为
$$
\lambda _i = -\frac{C_i(\vec x)}{\nabla C_i(\vec x)M^{-1}\nabla C_i(\vec x)^T}\ \ (5)
$$
一般来说，在处理每一个约束后，更新位置，经过大量的迭代，按照总约束变化量来改变速度
$$
\Delta \vec v = \frac{\Delta \vec x}{\Delta t}\ \ (6)
$$
## 4.2 优化观点
这里，我们提出了另一个观点，将PBD视为一个有条件优化(constrained optimization)的问题。仅考虑等式约束，问题可以被描述为公式(7)：
$$
求最小\ \ \frac{1}{2}\Delta \vec x^TM\Delta \vec x
$$
$$
符合\ C_i(\vec x + \Delta \vec x) = 0,\ \ i = 1,...,n
$$
变量\\(\Delta x\\)是满足约束的位置变化量。按照公式(6)，。因此，问题等同于找到满足约束条件的动能的最小变化，这与高斯的最小约束原理是一致的。  
如果约束函数是线性的，公式(7)就是一个二次规划问题。实践中，约束往往是非线性、非凸函数，对此，没有快速、全局优化的解算器。PBD使用SQP通过线性化约束并计算一序列QP问题来解决：
$$
求最小\ \ \frac{1}{2}\Delta \vec x^TM\Delta \vec x
$$
$$
符合\ J\Delta x = b
$$
这里，\\(J = \nabla C(x)\\)，\\(b = [-C_1,...,-C_n]^T\\)。这类问题(在线性约束下求二次目标函数最小值)能被转化为以下优化情况。
$$
M\Delta x = J^T\lambda\ \ (9)
$$
$$
J\Delta x = b\ \ (10)
$$
第一个式子来自拉格朗日乘数法，公式左边是目标函数的梯度，第二个式子来自可行性要求。
## 4.3 SOR
如上面描写的平均约束力确保了收敛，但是在一些情况，这种平均十分过激并且求解所需的迭代次数增加。我们提出一个控制SOR率的全局用户参数w来解决这个问题。

## 5 刚体
Harada[[2007]()]和Bell[[2005]()]使用惩罚力模型的粒子表示去模拟刚体，同时Tonge[[2010]()]使用粒子去侦测联系来构建一个基于约束力的GPU刚体解算器。另一个方式是通过距离约束来联系晶格粒子来构建刚体，然而这种方式需要很多迭代来表现刚性。  
我们用粒子表示非凸刚体，使用刚体形状匹配约束[[Muller et al. 2005]()]来保持粒子构造。通过首先对封闭的三角形网格进行体素化并将粒子放置在该形状内部的已占据单元格中，来创建形状。然后，我们为形状中的所有粒子分配相同的相位(phase)标识符，禁用它们之间的碰撞，并向系统添加形状匹配约束。
在进行模拟的时候，我们处理粒子就像他们没有联系，使他们被其他类型的约束处理。
## 5.1用稀疏符号距离场解决碰撞
Harada[[2007]()]使用属于刚体的粒子间的离散元素的力来解决碰撞。然而，物体可能会互锁并无法分开。我们用一种基于稀疏符号距离场(SDF)的新的粒子碰撞算法。  
Guendelman et al. [[2003]()]使用符号距离场来产生非凸刚体之间的联系。然后使用顺序的迭代方案解决冲突，其中，每个特征都按照最深的穿透顺序从形状中投影出来。与它，使用基于刚体的SDF方法，相比，我们为属于一个刚体的每一个粒子采样一个场函数。通过将SDF存储于粒子，我们能重新使用我们粒子-粒子碰撞侦测的机制来解决形状间更深的重叠。我们存储每个粒子位置处的SDF值和梯度(图7)，可以将其视为近似的一阶稀疏表示基础场。更高阶的表示也是可能的，被描述于[[Corbett 2005]()]。  
![](/img/UPPRA_SDF.png)  
`图7 ：我们存储了每个粒子的带符号距离场的值和梯度来防止刚体相互穿过和锁住。注意，在中间轴上的粒子的梯度方向是随意的。`   
为了使用这种表示法解决碰撞，我们首先使用\\(|X_i - X_j| < r\\)侦测粒子间的重叠。

$$
n_{ij}=
\begin{cases}
\nabla \phi _i& \text{if|\phi _i|<|\phi _j|}\\\\
-\nabla \phi _j& \text{otherwise}
\end{cases}
$$  

位置每个粒子的改变量为：  

$$
\delta X_i = 
-\frac{\omega _i}{\omega _i + \omega _j}(d\dot n_{ij})  
$$

在形状的表面附近，带符号距离场的采样经常不够，这会导致不连续的穿透深度和抖动。为了解决这个问题，我们将边界粒子(具有\\(|\phi | < r|\\)的粒子)与上述内部粒子的方法分开处理。当碰撞发生在边界粒子和其他粒子间时，我们将接触法线按照[[Muller and Chentanez 2011a]()]修改，将边界粒子处理为一个单边球星。  
这种修改后的边界法线(图8)能被高效地作为碰撞侦测的反应(reflection)来计算(公式7)，当一个粒子在边界粒子的负半空间。   

## 5.3 变形
每一种形状约束都有一个刚性系数使我们可以模拟一些小尺度的弹性形变。除此之外，我们能使用被描述在[[Muller and Chentanez 2011b]()]的方法对物体进行塑形变形。简短地，简而言之，我们检测属于刚性形状的粒子何时变形超过用户阈值。然后，根据塑形蠕变系数，我们将变形结果与粒子的局部空间静止位置相混合。因为此过程使我们的SDF场无效，所以如果它们变形超过某个阈值，我们会将其转换回规则的球形粒子。  
当前，我们对每个对象使用单个形状匹配约束，这限制了可能的变形量。可以通过组合多个形状匹配约束或使用诸如定向粒子(oriented particles)或四面体体积约束(tetrahedral volume constraints)之类的方法来支持较大的变形，这两种方法都可以容纳在我们的约束框架中。  
## 6 颗粒材质与摩擦  
我们在颗粒材料的情况下展示我们的摩擦模型，颗粒材料的行为在很大程度上取决于摩擦效果。但是，我们注意到，这里介绍的相同方法用于我们框架中的所有对象类型。贝尔等人的先前工作。 [2005]使用离散元法和不规则的颗粒群对颗粒材料进行建模。 Zhu和Bridson [2005]使用FLIP方法对沙子进行动画处理，而Alduan和Otaduy [´2011]，以及Ihmsen等人则使用FLIP方法。 [2012b]使用迭代平滑粒子流体动力学（SPH）求解器对具有摩擦和内聚力的颗粒材料进行建模。传统上，基于位置的动力学在完成基于位置的约束求解后，通过阻尼速度对摩擦进行建模[Muller等。 2007]。该方法无法对静摩擦建模，因为摩擦阻尼力无法校正约束求解过程中已经发生的位置变化。因此，粒子位置漂移，并且桩快速塌陷。我们使用一种在位置级别施加摩擦的新颖配方解决了这个问题。  
## 6.1 摩擦力模型
在接触处理过程中，我们首先根据以下非渗透约束，通过沿碰撞法线投影距离d来解决互穿问题，  
互穿问题解决后，我们将根据此时间步中粒子的相对切向位移来计算摩擦位置增量  
其中x ∗ i和x ∗ j是包含任何先前应用的约束增量的碰撞粒子的当前候选位置，xi和xj是时间步开始时粒子的位置，n = x ∗ ij / |。 x * ij | 是正常的联系方式。 然后，将粒子i的摩擦位置增量计算为  
## 7 流体
我们使用基于位置的流体方法[Macklin and Muller 2013¨]在我们的框架中模拟流体，其中流体密度约束（方程26）被简单地视为系统中的另一个约束。 与[Macklin and Muller 2013¨]相反，我们将密度约束限制为非负（单边），因此它仅用于分离粒子，  
然后，我们使用[Akinci等人的模型。 2013a]处理内聚力和表面张力效应  
## 7.1 流固混合
### 7.1.1 浮力
[Macklin and Muller 2013¨]的密度约束公式将流体粒子视为具有相等的质量，但是通过使用基于位置的动力学的质量加权形式（公式4），我们可以模拟具有不同密度的流体和刚体。这种简单的调整会自动引起物体质量比不同的物体的浮力和下沉（图12）。对于流体密度约束，我们预先计算了等式中的分母。 （5）为参考填充粒子的配置。在此预计算步骤中，我们假设相邻粒子的质量相同，因此可以确保根据等式进行后续位置校正。 （4）是保守的，应使用系统中最小的预期颗粒质量。为了模拟不混溶的多相液体（图13），我们允许不同相的流体粒子对彼此的密度估计有所贡献。我们仅在与[Solenthaler and Pajarola 2008]中相同相的粒子之间施加内聚力和表面张力。  
事实证明，基于网格的方法普遍适用于对气体和烟雾进行动画处理，特别是[Stam 1999]和[Fedkiw等。 2001]。 最近，拉格朗日烟的离散化引起了人们对计算机图形学的兴趣，特别是诸如[Park and Kim 2005]等涡旋方法和网格跟踪方法[Pfaff等。 2012] [Brochu et al。 2012]。 Stam和Fiume [1995]最早将SPH应用于气体和火的模拟，Gao等。 [2009]将SPH与基于网格的流体求解器相结合，以模拟快速移动的气体。 我们提出了一种基于位置流体模拟气体的完全拉格朗日方法。 我们的方法是稀疏的，因为它仅计算视觉感兴趣区域中的流体动力学，并且与需要对固体边界进行特殊处理的涡旋粒子方法相反，我们的方法通过在规则的粒子碰撞期间通过简单的位置投影来处理固体边界条件 约束管道。  
### 7.2.4 渲染
与基于网格的求解器不同，它没有对拉格朗日方案的内置扩散。 为了在视觉上近似烟气密度的扩散，我们增加了烟气的粒径，并降低了烟尘在整个寿命过程中的不透明度，类似于[Brochu等人。 2012]。 对于我们的实时渲染器，我们根据相机的深度对烟雾粒子进行排序，并将其渲染为点精灵。 通过将粒子作为不透明点渲染到阴影图中，并将光空间深度增量视为指数散射函数的输入，可以近似估计透光效果。  
## 9 实现细节
约束可以以粒子为中心或约束为中心的方式解决。在以粒子为中心的方法（算法2）中，我们为每个粒子分配一个GPU线程，并在影响它的所有约束上循环，一旦处理了所有约束，就对每个粒子执行一次写入操作。或者，我们可以以约束为中心的方式（算法3）求解约束，其中每个线程处理约束并使用原子操作将位置增量散布到每个受影响的粒子上。实际上，我们根据约束类型使用两种方法。例如，以粒子为中心的方式求解流体密度约束，以约束为中心的方式求解距离约束。尽管基于原子内存事务的分散写入通常效率较低，但我们发现这种方法在当前的GPU硬件上非常实用。通过根据哈希网格单元索引对粒子数据进行重新排序，可以改善内存事务中的一致性。对于大型形状（例如墙和地板），粒子是碰撞图元的低效选择。我们使用传统表示法（例如凸包，有符号距离场和三角形网格）来表示这些运动学形状  
## 10 结果

1090/5000
我们已在CUDA中实现了求解器，并在NVIDIA GTX680 GPU上测量了各种场景的时序（表1）。这些时间不包括渲染，但是除了Rayleigh-Taylor场景外，我们的所有结果都是实时捕获的，Rayleigh-Taylor场景由300k粒子组成，并且每帧的模拟时间约为150ms。我们使用[Macklin and Muller 2013¨]中描述的椭圆形喷溅和屏幕空间堆焊来渲染流体。图1显示了流体，刚体，布料和绳索以及双向相互作用，我们布料上的阻力模型通过连接绳索减慢了刚性兔子的下降速度。图16显示了模拟中的框架，其中一块布料掉落撞击刚性物体，然后与由于斜压湍流而上升的烟羽相互作用。图18显示了由布满流体颗粒的布网制成的水气球。当用户拉动布料网格时，我们会动态删除约束，使他们能够撕开网格并释放流体。因为流体和布料是双向耦合的，所以逸出的流体迫使气球向后运动。  